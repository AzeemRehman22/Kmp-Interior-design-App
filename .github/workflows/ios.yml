name: Build IPA (KMP)

on:
  workflow_dispatch:  # Manual trigger

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build shared framework (Compose Multiplatform/KMP)
        run: ./gradlew :composeApp:assembleXCFramework

      - name: Install CocoaPods (if exist)
        run: |
          if [ -f iosApp/Podfile ]; then
            cd iosApp
            pod install
          fi

      - name: Build IPA (Unsigned)
        run: |
          cd iosApp
          xcodebuild \
            -scheme iosApp \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive \
            -archivePath build/iosApp.xcarchive

          mkdir -p build/ipa/Payload
          cp -R build/iosApp.xcarchive/Products/Applications/*.app build/ipa/Payload/
          cd build/ipa && zip -r iosApp.ipa Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v3
        with:
          name: iosApp-ipa
          path: iosApp/build/ipa/iosApp.ipa
